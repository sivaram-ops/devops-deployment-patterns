---
# tasks file for mysql
# Local Variables (defined where needed for multi-use or security)
- name: Set necessary multi-use deployment variables
  set_fact:
    tmp_dir: "/tmp/mysql_setup"
    # The password used throughout the rest of the tasks
    mysql_root_password: "RoboShop@1"

# 1. Repository Setup & MySQL Installation (Fixes for GPG/Download/403)

- name: Ensure temporary directory exists
  file:
    path: "{{ tmp_dir }}"
    state: directory
    mode: '0755'

# Using curl/shell against the stable repo link to bypass the 403 Forbidden error
- name: Download the MySQL 5.7 community release RPM
  shell: |
    curl -s -L -o {{ tmp_dir }}/mysql-community-release.rpm "https://repo.mysql.com//mysql57-community-release-el7-11.noarch.rpm"
  args:
    creates: "{{ tmp_dir }}/mysql-community-release.rpm"

- name: Install the MySQL 5.7 community release RPM
  dnf:
    name: "{{ tmp_dir }}/mysql-community-release.rpm"
    state: present
    disable_gpg_check: yes

- name: Import MySQL GPG Key (optional, but recommended if the above fails)
  rpm_key:
    key: https://repo.mysql.com/RPM-GPG-KEY-mysql # RPM-GPG-KEY-mysql-2023
    state: present

- name: Install MySQL Community Server
  dnf:
    name: mysql-community-server
    state: present
    enablerepo: mysql57-community
    disable_gpg_check: yes
    # The 'omit' is required for compatibility with Ansible facts, so we keep the check
    # disable_excludes: "{{ 'main' if ansible_distribution_major_version == '7' else omit }}" # disabled it.

# 2. Dependencies & Service Management

- name: Ensure 'pip' and PyMySQL are installed
  dnf:
    name: python3-pip
    state: present
  
- name: Install PyMySQL using pip
  pip:
    name: PyMySQL
    state: present

- name: Enable on boot and start the MySQL service
  systemd_service:
    name: mysqld
    state: started
    enabled: yes
    daemon_reload: yes # added

- name: Try logging into MySQL with desired root password (check if already set)
  shell: |
    mysql -u root -p'{{ mysql_root_password }}' -e "SELECT 1;" >/dev/null 2>&1
  register: root_pw_check
  changed_when: false
  failed_when: false

- name: Read temporary password from mysqld.log (only if root pw not set)
  shell: |
    awk '/temporary password/ {print $NF}' /var/log/mysqld.log | tail -1
  register: mysql_temp_password
  changed_when: false
  when: root_pw_check.rc != 0

- name: Set new root password using temporary password (MySQL 5.7)
  shell: |
    mysql --connect-expired-password -u root -p'{{ mysql_temp_password.stdout | trim }}' \
      -e "ALTER USER 'root'@'localhost' IDENTIFIED BY '{{ mysql_root_password }}';"
  register: set_root_pw
  changed_when: set_root_pw.rc == 0
  failed_when: set_root_pw.rc not in [0]
  when:
    - root_pw_check.rc != 0
    - mysql_temp_password.stdout | trim != ""
  no_log: true

- name: Remove validate_password plugin if present
  shell: |
    mysql -u root -p'{{ mysql_root_password }}' -e "UNINSTALL PLUGIN validate_password;"
  register: remove_validate
  failed_when: false
  changed_when: "'ERROR' not in remove_validate.stderr"
  no_log: true

- name: Download MySQL schema zip
  get_url:
    url: "{{ schema_zip_url }}"
    dest: "{{ schema_workdir }}/mysql.zip"
    mode: "0644"

- name: Unarchive schema into /tmp (idempotent)
  unarchive:
    src: "{{ schema_workdir }}/mysql.zip"
    dest: "{{ schema_workdir }}"
    remote_src: yes
    creates: "{{ schema_workdir }}/{{ schema_dir_name }}"
# if this schema directory already exists, then this task will be skipped.

- name: Load shipping.sql schema
  shell: |
    mysql -u root -p'{{ mysql_root_password }}' < "{{ schema_workdir }}/{{ schema_dir_name }}/{{ schema_file }}"
  args:
    creates: "/var/lib/mysql/shipping_loaded.flag"
  register: load_schema
  changed_when: load_schema.rc == 0
  failed_when: load_schema.rc not in [0]
  no_log: true

- name: Mark schema as loaded (simple idempotency flag)
  file:
    path: /var/lib/mysql/shipping_loaded.flag
    state: touch
  when: load_schema is defined and load_schema.rc == 0
