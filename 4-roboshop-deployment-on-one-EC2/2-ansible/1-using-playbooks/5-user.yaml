---
- name: Roboshop's User Application deployment play.
  hosts: aws
  become: yes

  vars:
    redis_host_ip: "127.0.0.1"
    mongodb_host_ip: "127.0.0.1"
    app_dir: /home/roboshop/user # Define the application directory for clarity

  tasks:
    - name: Installing NodeJS, Make, and gcc-c++.
      dnf:
        name:
          - nodejs
          - make
          - gcc-c++
        state: present

    - name: Creating an user named roboshop.
      user:
        name: roboshop
        state: present

    # Using the defined app_dir variable
    - name: Creating a directoy for the user content.
      file:
        dest: "{{ app_dir }}"
        state: directory
        owner: roboshop
        group: roboshop
        mode: '0700'
    
    # ðŸš€ NEW TASK: Copy the local application code to the remote server.
    - name: Copying local User application code to the remote host.
      copy:
        src: ../../1-roboshop-source-code-for-1-VM/3-user/
        dest: "{{ app_dir }}"
        owner: roboshop
        group: roboshop
        mode: '0644' # Files generally need 0644, directories 0755/0700 (set by previous task)
      # The previous unarchive, move, and cleanup tasks are now REMOVED.

    - name: Ensure a temporary directory exists with correct ownership for npm installation.
      file:
        path: /home/roboshop/.ansible/tmp
        state: directory
        owner: roboshop
        group: roboshop
        mode: '0700'

    - name: Installing nodejs application dependencies as roboshop user.
      become: yes
      become_user: roboshop
      community.general.npm:
        path: "{{ app_dir }}"

    # ðŸš€ IMPROVED TASK: Copy the systemd file from the local source directory.
    - name: Copying the user application's service file to etc/systemd/system.
      copy:
        src: ../../1-roboshop-source-code-for-1-VM/3-user/systemd.service
        dest: /etc/systemd/system/user.service
        owner: root
        group: root
        mode: '0644'
      # Removed 'remote_src: yes' as we are copying from the local control machine.

#    - name: Updating the application's configuration file with Redis IP.
#      replace:
#        path: "/etc/systemd/system/user.service"
#        regexp: '^Environment=REDIS_HOST=REDIS_ENDPOINT'
#        replace: 'Environment=REDIS_HOST={{ redis_host_ip }}'
#        backup: yes

#    - name: Updating the application's configuration file with MongoDB Ip.
#      replace:
#        path: "/etc/systemd/system/user.service"
#        regexp: '^Environment=MONGO_URL="mongodb://MONGO_ENDPOINT:27017/users"'
#        replace: 'Environment=MONGO_URL=mongodb://{{ mongodb_host_ip }}:27017/user'
#        backup: yes

    - name: Reloading the systemd daemon service.
      systemd_service:
        daemon_reload: yes

    - name: Enabling and starting the user application.
      systemd_service:
        name: user
        state: started
        enabled: yes