---
- name: Roboshop's Catalogue application deployment play.
  hosts: aws
  become: true
  
  # Define the application directory on the remote host for easy reference
  vars:
    app_dir: /home/roboshop/catalogue

  tasks:
    - name: Installing nodejs, make, and gcc-c++.
      dnf:
        name:
          - nodejs
          - make
          - gcc-c++
        state: present

    - name: Creating an user named roboshop.
      user:
        name: roboshop
        state: present

    # ðŸš€ NEW TASK: Ensure the application directory exists
    - name: Ensure application directory exists with correct ownership.
      file:
        path: "{{ app_dir }}"
        state: directory
        owner: roboshop
        group: roboshop
        mode: '0755'

    # ðŸš€ NEW TASK: Copy the local application code to the remote server.
    # The 'src' path is relative to the directory where the playbook is located (2-ansible/playbooks).
    - name: Copying local Catalogue application code (server.js, package.json) to the remote host.
      copy:
        src: ../../1-roboshop-source-code-for-1-VM/2-catalogue/
        dest: "{{ app_dir }}"
        owner: roboshop
        group: roboshop
        mode: '0644'
      
    # The original "Downloading and Unarchiving" task and the subsequent "Renaming" task are REMOVED.
    # The 'copy' task above achieves the same goal by placing the files directly in the target directory.

    - name: Installing nodejs application dependencies as roboshop user.
      become: true
      become_user: roboshop
      community.general.npm: # Use the full FQCN for better clarity if the collection is known
        path: "{{ app_dir }}"

    # ðŸš€ IMPROVEMENT: Use the local systemd file instead of hardcoding content.
    - name: Copying the Catalogue Service configuration file from local source.
      copy:
        src: ../../1-roboshop-source-code-for-1-VM/2-catalogue/systemd.service
        dest: /etc/systemd/system/catalogue.service
        owner: root
        group: root
        mode: '0644'
      
    # The original "making the Service configuration file with copy module" task is REMOVED.

    - name: Starting and enabling the catalogue service.
      systemd_service:
        name: catalogue
        state: started
        enabled: true
        daemon_reload: true
