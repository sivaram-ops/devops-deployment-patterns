---
- name: Roboshop's Shipping application deployment Play.
  hosts: aws
  become: yes

  vars:
    cart_host_ip: "127.0.0.1" # Using cart_host_ip for CART_ENDPOINT
    db_host_ip: "127.0.0.1"   # Using db_host_ip for DB_HOST (MySQL)
    app_dir: /home/roboshop/shipping

  tasks:
    - name: Installing Maven (and Java if not present, as Maven depends on it).
      dnf:
        name: maven
        state: present

    - name: Creating an user named roboshop.
      user:
        name: roboshop
        state: present

    - name: Ensure application directory exists.
      file:
        dest: "{{ app_dir }}"
        state: directory
        owner: roboshop
        group: roboshop
        mode: '0700'

    # The original remote download and unarchive tasks are REMOVED (Tasks 3-5)

    # ðŸš€ NEW TASK: Copy the local application source code to the remote server.
    - name: Copying local Shipping application source code to the remote host.
      copy:
        src: ../../1-roboshop-source-code-for-1-VM/5-shipping/
        dest: "{{ app_dir }}"
        owner: roboshop
        group: roboshop
        mode: '0644' # Default file mode

    - name: Ensuring a temporary directory exists with correct ownership for Maven.
      # While the Maven build happens in /home/roboshop/shipping, 
      # this is a general Ansible best practice for user-run commands.
      file:
        path: /home/roboshop/.ansible/tmp
        state: directory
        owner: roboshop
        group: roboshop
        mode: '0700'

    - name: Building shipping JAR file as roboshop user.
      # This task is idempotent if the JAR file is already built, but typically we run it every time.
      become: yes
      become_user: roboshop
      command:
        cmd: mvn clean package
        chdir: "{{ app_dir }}"
      
      # NOTE: Maven places the JAR file in target/shipping-1.0.jar

    # This task is now simpler as it just needs to create an alias/copy to the required name
    - name: Moving and renaming the JAR file to shipping.jar
      copy:
        src: "{{ app_dir }}/target/shipping-1.0.jar"
        dest: "{{ app_dir }}/shipping.jar"
        remote_src: yes # Source is on the remote server
        owner: roboshop
        group: roboshop
        mode: '0644'

    # ðŸš€ IMPROVED TASK: Copy the systemd file from the local source directory.
    - name: Copying the shipping systemd service file.
      copy:
        src: ../../1-roboshop-source-code-for-1-VM/5-shipping/systemd.service
        dest: /etc/systemd/system/shipping.service
        owner: root
        group: root
        mode: '0644'
      # The original task's 'content' block is REMOVED.

#    # ðŸš€ NEW TASK: Updating CART_ENDPOINT
#    - name: Updating the Shipping application's configuration file with Cart IP.
#      replace:
#        path: "/etc/systemd/system/shipping.service"
#        # Assuming the original placeholder in your local systemd.service file is `CARTENDPOINT:8080`
#        regexp: '^(Environment=CART_ENDPOINT=).+$'
#        replace: '\1{{ cart_host_ip }}:8080'
#        backup: yes

#    # ðŸš€ NEW TASK: Updating DB_HOST
#    - name: Updating the Shipping application's configuration file with DB Host IP.
#      replace:
#        path: "/etc/systemd/system/shipping.service"
#        # Assuming the original placeholder in your local systemd.service file is `DBHOST`
#        regexp: '^(Environment=DB_HOST=).+$'
#        replace: '\1{{ db_host_ip }}'
#        backup: yes

    - name: Reloading systemd daemon.
      systemd_service:
        daemon_reload: yes

    - name: Enabling and starting the shipping service.
      systemd_service:
        name: shipping
        enabled: yes
        state: started