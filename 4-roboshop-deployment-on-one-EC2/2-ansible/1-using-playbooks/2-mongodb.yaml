---
- name: Roboshop's MongoDB Deployment and Schema Load (RHEL-based Distros)
  hosts: aws
  become: yes

  vars:
    mongodb_version: "7.0"
    # Removed schema_repo_url as we are using local files
    # Updated schema_extract_dir to use a simple path for local copies
    schema_temp_dir: "/tmp/schema_files" # New temporary directory for local files
    flag_path_catalogue: "/tmp/.catalogue_data_loaded"
    flag_path_user: "/tmp/.user_data_loaded"

  handlers:
    - name: start mongod service
      systemd:
        name: mongod
        state: started
        enabled: true

    - name: restart mongod service
      systemd:
        name: mongod
        state: restarted
        enabled: true

  tasks:
    - name: 1. Create MongoDB repository file.
      copy:
        content: |
          [mongodb-org-{{ mongodb_version }}]
          name=MongoDB Repository
          baseurl=https://repo.mongodb.org/yum/amazon/2023/mongodb-org/{{ mongodb_version }}/x86_64/
          gpgcheck=1
          enabled=1
          gpgkey=https://www.mongodb.org/static/pgp/server-{{ mongodb_version }}.asc
        dest: /etc/yum.repos.d/mongodb-org-{{ mongodb_version }}.repo
        owner: root
        mode: '0644'

    - name: 2. Install MongoDB Server and the OpenSSL 3 Shell.
      dnf:
        name:
          - mongodb-org
          - mongodb-mongosh-shared-openssl3.x86_64
        state: present
        update_cache: yes
      notify: start mongod service

    - name: 3. Update MongoDB bindIp in configuration file.
      replace:
        path: /etc/mongod.conf
        regexp: '^#?bindIp: 127\.0\.0\.1$'
        replace: 'bindIp: 0.0.0.0'
        backup: yes
      notify: restart mongod service

    - name: 4. Ensure MongoDB service is running before loading schema.
      meta: flush_handlers

    # ðŸš€ NEW TASK 5a: Create the temporary directory to place the schema files
    - name: 5a. Create temporary directory for schema files.
      file:
        path: "{{ schema_temp_dir }}"
        state: directory
        mode: '0755'

    # ðŸš€ NEW TASK 5b: Copy the local schema content to the remote server.
    # The 'src' path is relative to the playbook location.
    - name: 5b. Copy local schema content to the temporary directory.
      copy:
        src: ../../1-roboshop-source-code-for-1-VM/7-mongodb/
        dest: "{{ schema_temp_dir }}"

    # The original "5. Download and Unarchive schema content" is REMOVED

    - name: 6. Checking if catalogue data is already loaded or not.
      stat:
        path: "{{ flag_path_catalogue }}"
      register: catalogue_data_flag

    - name: 7. Load catalogue schema from catalogue.js.
      shell:
        cmd: "mongosh < catalogue.js"
        chdir: "{{ schema_temp_dir }}" # Updated to use the new temp dir
        executable: /bin/bash
      register: data_loaded_catalogue
      when: not catalogue_data_flag.stat.exists

    - name: 8. Create flag file for catalogue data.
      file:
        path: "{{ flag_path_catalogue }}"
        state: touch
      when: data_loaded_catalogue is defined and data_loaded_catalogue.rc is defined and data_loaded_catalogue.rc == 0

    - name: 9. Check if User data is already loaded.
      stat:
        path: "{{ flag_path_user }}"
      register: user_data_flag

    - name: 10. Load user schema from users.js.
      shell:
        cmd: "mongosh < users.js"
        chdir: "{{ schema_temp_dir }}" # Updated to use the new temp dir
        executable: /bin/bash
      register: data_loaded_user
      when: not user_data_flag.stat.exists

    - name: 11. Create flag file for user data.
      file:
        path: "{{ flag_path_user }}"
        state: touch
      when: data_loaded_user is defined and data_loaded_user.rc is defined and data_loaded_user.rc == 0

    - name: 12. Clean up downloaded archive and extracted folder.
      file:
        path: "{{ item }}"
        state: absent
      loop:
        # Removed /tmp/mongodb.zip cleanup as we no longer download it
        - "{{ schema_temp_dir }}" # Updated to clean up the new temp directory