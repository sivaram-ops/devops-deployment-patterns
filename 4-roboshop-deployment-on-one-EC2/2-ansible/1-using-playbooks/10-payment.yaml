---
- name: Roboshop's Payment application deployment play.
  hosts: aws
  become: yes

  vars:
    app_dir: /home/roboshop/payment
    cart_host_ip: "127.0.0.1" # For CART_HOST
    user_host_ip: "127.0.0.1" # For USER_HOST
    amqp_host_ip: "127.0.0.1" # For AMQP_HOST

  tasks:
    - name: Ensuring roboshop user exists.
      user:
        name: roboshop
        state: present
      register: roboshop_user

    - name: Gathering roboshop user's facts (UID/GID) for configuration.
      getent:
        database: passwd
        key: roboshop
      register: roboshop_user_info
      # UID is roboshop_user_info.ansible_facts.getent_passwd.roboshop[2]
      # GID is roboshop_user_info.ansible_facts.getent_passwd.roboshop[3]

    - name: Installing dependencies including python3, gcc, python3-devel.
      dnf:
        name:
          - python3
          - gcc
          - python3-devel
          - python3-pip
        state: present

    - name: Creating application directory.
      file:
        path: "{{ app_dir }}"
        state: directory
        owner: roboshop
        group: roboshop
        mode: '0755'

    # The original remote download, unarchive, and rename tasks are REMOVED (Tasks 4-5)

    # ðŸš€ NEW TASK: Copy the local Payment application source code to the remote server.
    - name: Copying local Payment application source code to the remote host.
      copy:
        src: ../../1-roboshop-source-code-for-1-VM/6-payment/
        dest: "{{ app_dir }}"
        owner: roboshop
        group: roboshop
        mode: '0644'

    - name: Installing the Python application dependencies using pip3.6
      pip:
        requirements: "{{ app_dir }}/requirements.txt"
        executable: pip3
        # Ensure the user has permissions to write to site-packages, though dnf pip3 should handle it.
        # Running as root (become: yes) is generally fine for system-wide installs.

#    - name: Updating the 'uid' in payment.ini using the dynamic user ID.
#      lineinfile:
#        path: "{{ app_dir }}/payment.ini"
#        regexp: '^uid='
#        line: 'uid={{ roboshop_user_info.ansible_facts.getent_passwd.roboshop[2] }}'
#        owner: roboshop
#        group: roboshop
#        mode: '0644'

    - name: Updating the 'uid' in payment.ini to use the 'roboshop' user name.
      lineinfile:
        path: "{{ app_dir }}/payment.ini"
        regexp: '^uid='
        line: 'uid=roboshop'  # <<< FIXED: Using the user name directly
        owner: roboshop
        group: roboshop
        mode: '0644'

#    - name: Updating 'gid' in payment.ini using the dynamic group ID
#      lineinfile:
#        path: "{{ app_dir }}/payment.ini"
#        regexp: '^gid='
#        line: 'gid={{ roboshop_user_info.ansible_facts.getent_passwd.roboshop[3] }}'
#        owner: roboshop
#        group: roboshop
#        mode: '0644'

    - name: Updating 'gid' in payment.ini to use the 'roboshop' group name.
      lineinfile:
        path: "{{ app_dir }}/payment.ini"
        regexp: '^gid='
        line: 'gid=roboshop'  # <<< FIXED: Using the group name directly
        owner: roboshop
        group: roboshop
        mode: '0644'

    # ðŸš€ IMPROVED TASK: Copy the systemd service file from the local source directory.
    - name: Copying and configuring the payment.service file.
      copy:
        src: ../../1-roboshop-source-code-for-1-VM/6-payment/systemd.service
        dest: /etc/systemd/system/payment.service
        owner: root
        group: root
        mode: '0644'
      # The original task using `content` is replaced by this.

#    # ðŸš€ NEW TASK: Update Environment variables in the service file
#    - name: Configure environment variables in payment.service.
#      lineinfile:
#        path: /etc/systemd/system/payment.service
#        regexp: '^(Environment={{ item.key }}=).*$'
#        line: 'Environment={{ item.key }}={{ item.value }}'
#        backup: yes
#      loop:
#        - { key: 'CART_HOST', value: '{{ cart_host_ip }}' }
#        - { key: 'USER_HOST', value: '{{ user_host_ip }}' }
#        - { key: 'AMQP_HOST', value: '{{ amqp_host_ip }}' }
#        # Note: AMQP_USER and AMQP_PASS are hardcoded in the service file and match the RabbitMQ configuration, so no need to replace.

    - name: Reloading the systemd daemon.
      systemd_service:
        daemon_reload: yes

    - name: Enabling and starting the payment service.
      systemd_service:
        name: payment
        state: started
        enabled: yes