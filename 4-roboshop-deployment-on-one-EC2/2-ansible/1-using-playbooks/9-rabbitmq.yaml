---
- name: Roboshop's RabbitMQ server deployment play (Reliable Shell Commands).
  hosts: aws
  become: yes

  vars:
    rabbitmq_repo_src: ../../1-roboshop-source-code-for-1-VM/10-rabbitmq/rabbitmq.repo

  tasks:
    # --- Installation and Dependencies (Mirrors your DNF commands) ---
    - name: Ensuring prerequisites are installed.
      dnf:
        name:
          - socat
          - logrotate
        state: present

    - name: Importing RabbitMQ GPG signing keys.
      rpm_key:
        state: present
        key: "{{ item }}"
      loop:
        - https://github.com/rabbitmq/signing-keys/releases/download/2.0/rabbitmq-release-signing-key.asc
        - https://dl.cloudsmith.io/public/rabbitmq/rabbitmq-erlang/gpg.E495BB49CC4BBE5B.key
        - https://dl.cloudsmith.io/public/rabbitmq/rabbitmq-server/gpg.9F4587F226208342.key

    - name: Copying local RabbitMQ repository file to /etc/yum.repos.d/.
      copy:
        src: "{{ rabbitmq_repo_src }}"
        dest: /etc/yum.repos.d/rabbitmq.repo
        mode: '0644'

    - name: Clean DNF metadata and cache and perform update.
      command: dnf update -y --refresh

    - name: Installing Erlang and RabbitMQ Server.
      dnf:
        name:
          - erlang
          - rabbitmq-server
        state: present

    # --- Service Management (Mirrors your systemctl commands) ---
    - name: Enabling and Starting the rabbitmq service.
      service:
        name: rabbitmq-server
        state: started
        enabled: yes

    # --- Configuration (Mirrors your successful rabbitmqctl commands) ---
    # We use 'shell' for these to ensure idempotent checks where possible
    
    - name: Add user 'roboshop' (only if it doesn't exist).
      shell: |
        if ! rabbitmqctl list_users | grep -q roboshop; then
          rabbitmqctl add_user roboshop roboshop123
        fi
      register: add_user_output
      changed_when: "'Adding user' in add_user_output.stdout"

    - name: Set 'administrator' tags for 'roboshop' user.
      command: rabbitmqctl set_user_tags roboshop administrator
      
    - name: Set full permissions for 'roboshop' on '/' vhost.
      command: rabbitmqctl set_permissions -p / roboshop ".*" ".*" ".*"

    - name: Enable RabbitMQ management plugin.
      command: rabbitmq-plugins enable rabbitmq_management
      register: enable_plugin_output
      # Note: Enabling the plugin often requires a restart, but in your successful manual run, 
      # it seemed to work without an explicit restart command afterward.
      # If the login still fails, we will add a final service restart here.

    - name: Print successful deployment message
      debug:
        msg: "RabbitMQ deployment complete using direct shell commands. Login with roboshop/roboshop123 should be successful."